<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dá»‹ch phá»¥ Ä‘á» SRT (Gemini API)</title>
<style>
body { font-family: Arial, sans-serif; margin: 40px; background: #f9fafb; color: #111; }
h2 { color: #2563eb; }
label { display:block; margin-top:18px; }
input, select, button { font-size:1rem; padding:8px; margin-top:6px; width:100%; max-width:600px; }
button { background:#2563eb; color:white; border:none; border-radius:4px; cursor:pointer; }
button:hover { background:#1d4ed8; }
.progress-bar{width:100%;max-width:600px;height:18px;background:#e5e7eb;border-radius:10px;overflow:hidden;margin-top:10px;}
.progress-bar-inner{height:100%;width:0%;background:linear-gradient(90deg,#2563eb,#60a5fa);transition:width 0.3s;}
#status{margin-top:20px;font-weight:bold;}
#result{white-space:pre-wrap;background:#fff;padding:10px;border:1px solid #ddd;border-radius:6px;margin-top:20px;}
</style>
</head>
<body>

<h2>ğŸ¬ Dá»‹ch phá»¥ Ä‘á» SRT báº±ng Gemini API</h2>

<label>ğŸ”‘ API Key
  <input type="text" id="apiKey" placeholder="DÃ¡n API key táº¡i Ä‘Ã¢y">
</label>

<label>ğŸŒ NgÃ´n ngá»¯ Ä‘Ã­ch
  <select id="lang">
    <option value="vi">Tiáº¿ng Viá»‡t (vi)</option>
          <option value="en">English (en)</option>
          <option value="ja">æ—¥æœ¬èª (ja)</option>
          <option value="ko">í•œêµ­ì–´ (ko)</option>
          <option value="zh">ä¸­æ–‡ (zh)</option>
          <option value="fr">FranÃ§ais (fr)</option>
          <option value="es">EspaÃ±ol (es)</option>
  </select>
</label>

<label>ğŸ’« Phong cÃ¡ch dá»‹ch
  <select id="style">
    <option value="default">ğŸª¶ Máº·c Ä‘á»‹nh â€“ dá»‹ch chuáº©n tá»«ng cÃ¢u, tá»«ng chá»¯</option>
    <option value="tu tiÃªn">Tu tiÃªn</option>
    <option value="kiáº¿m hiá»‡p">Kiáº¿m hiá»‡p</option>
    <option value="xuyÃªn khÃ´ng">XuyÃªn khÃ´ng</option>
    <option value="há»‡ thá»‘ng">Há»‡ thá»‘ng</option>
    <option value="ngÃ´n tÃ¬nh hiá»‡n Ä‘áº¡i">NgÃ´n tÃ¬nh hiá»‡n Ä‘áº¡i</option>
    <option value="cá»• trang">Cá»• trang</option>
  </select>
</label>

<label>ğŸ“„ File phá»¥ Ä‘á» (.srt)
  <input type="file" id="fileInput" accept=".srt">
</label>

<button id="translateBtn">Dá»‹ch ngay</button>
<div class="progress-bar"><div id="progressInner" class="progress-bar-inner"></div></div>

<div id="status"></div>
<div id="result"></div>

<script>
function parseSRT(t){
  t=t.replace(/\r\n/g,"\n").trim();
  const b=t.split(/\n\s*\n/),out=[];
  for(const blk of b){
    const lines=blk.split("\n");
    if(lines.length>=3){
      out.push({seq:lines[0],time:lines[1].trim(),text:lines.slice(2).join("\n")});
    }
  }
  return out;
}
function formatSRT(items){return items.map(i=>`${i.seq}\n${i.time}\n${i.text}`).join("\n\n");}
function updateProgress(p){document.getElementById("progressInner").style.width=p+"%";}

function buildPrompt(style, targetLang, lines){
  const stylePrompts = {
    "default": `
HÃ£y dá»‹ch táº¥t cáº£ Ä‘oáº¡n srt dÆ°á»›i Ä‘Ã¢y tá»« tiáº¿ng Trung sang tiáº¿ng Viá»‡t chuáº©n nháº¥t cho tÃ´i 
vÃ  táº¡o thÃ nh phá»¥ Ä‘á» srt vÃ  pháº£i Ä‘Ãºng má»‘c thá»i gian cá»§a tÃ´i gá»­i, 
dá»‹ch sÃ¡t nghÄ©a tá»«ng cÃ¢u, tá»«ng chá»¯, giá»¯ nguyÃªn phong cÃ¡ch ká»ƒ chuyá»‡n, cáº£m xÃºc, lá»i thoáº¡i tá»± nhiÃªn nhÆ° báº£n gá»‘c. 
KhÃ´ng lÆ°á»£c bá»›t chi tiáº¿t, khÃ´ng tÃ³m táº¯t, phÃ¢n chia ngÃ´i cÃ¡c thá»© nhÃ¢n váº­t pháº£i rÃµ rÃ ng.`,
    "tu tiÃªn": `
Báº¡n lÃ  dá»‹ch giáº£ phim **tu tiÃªn cá»• Ä‘áº¡i**. 
Dá»‹ch sang ${targetLang} chuáº©n xÃ¡c tá»«ng chá»¯, giá»¯ nguyÃªn cáº£m xÃºc, lá»i thoáº¡i tá»± nhiÃªn.
DÃ¹ng cÃ¡c Ä‘áº¡i tá»« cá»• nhÆ°: sÆ° phá»¥, sÆ° huynh, sÆ° Ä‘á»‡, Ä‘áº¡o há»¯u, tiÃªn tá»­, chÃ¢n nhÃ¢n, linh khÃ­, phi thÄƒng...
NgÃ´n ngá»¯ trang trá»ng, phong cÃ¡ch tu tiÃªn HÃ¡n-Viá»‡t, mang sáº¯c thÃ¡i huyá»n áº£o vÃ  Ä‘áº¡o lÃ½.`,
    "kiáº¿m hiá»‡p": `
Báº¡n lÃ  dá»‹ch giáº£ phim **vÃµ hiá»‡p cá»• trang**.
Dá»‹ch sang ${targetLang} sÃ¡t nghÄ©a, lá»i thoáº¡i tá»± nhiÃªn, cáº£m xÃºc rÃµ rÃ ng.
DÃ¹ng cÃ¡c xÆ°ng hÃ´: cÃ¡c háº¡, táº¡i háº¡, tiá»n bá»‘i, huynh Ä‘Ã i, cÃ´ nÆ°Æ¡ng, giang há»“, vÃµ cÃ´ng...
Giá»¯ tinh tháº§n hiá»‡p nghÄ©a, hÃ nh hiá»‡p trÆ°á»£ng nghÄ©a, khÃ­ phÃ¡ch anh hÃ¹ng.`,
    "xuyÃªn khÃ´ng": `
Báº¡n lÃ  dá»‹ch giáº£ phim **xuyÃªn khÃ´ng huyá»n huyá»…n**.
Dá»‹ch sang ${targetLang}, giá»¯ phong cÃ¡ch sinh Ä‘á»™ng, hiá»‡n Ä‘áº¡i pha cá»• Ä‘áº¡i.
DÃ¹ng ngÃ´n ngá»¯ tá»± nhiÃªn, pháº£n Ã¡nh sá»± khÃ¡c biá»‡t thá»i Ä‘áº¡i giá»¯a nhÃ¢n váº­t xuyÃªn khÃ´ng vÃ  tháº¿ giá»›i cá»•.`,
    "há»‡ thá»‘ng": `
Báº¡n lÃ  dá»‹ch giáº£ phim **há»‡ thá»‘ng â€“ nhiá»‡m vá»¥ â€“ tu luyá»‡n**.
Dá»‹ch sang ${targetLang}, dÃ¹ng ngÃ´n ngá»¯ tá»± nhiÃªn, mang phong cÃ¡ch game/tiÃªn hiá»‡p.
Sá»­ dá»¥ng cÃ¡c thuáº­t ngá»¯ nhÆ°: há»‡ thá»‘ng, nhiá»‡m vá»¥, Ä‘iá»ƒm kinh nghiá»‡m, tÄƒng cáº¥p, váº­t pháº©m, tháº¿ giá»›i song song.`,
    "ngÃ´n tÃ¬nh hiá»‡n Ä‘áº¡i": `
Báº¡n lÃ  dá»‹ch giáº£ phim **ngÃ´n tÃ¬nh hiá»‡n Ä‘áº¡i**.
Dá»‹ch sang ${targetLang}, lá»i thoáº¡i má»m máº¡i, tá»± nhiÃªn, mang cáº£m xÃºc.
DÃ¹ng cÃ¡ch xÆ°ng hÃ´: anh, em, cÃ´ áº¥y, cáº­u áº¥y, giá»ng nÃ³i nháº¹ nhÃ ng, gáº§n gÅ©i.`,
    "cá»• trang": `
Báº¡n lÃ  dá»‹ch giáº£ phim **cá»• trang Trung Hoa**.
Dá»‹ch sang ${targetLang} chuáº©n xÃ¡c, dÃ¹ng ngÃ´n ngá»¯ HÃ¡n-Viá»‡t trang trá»ng.
DÃ¹ng Ä‘áº¡i tá»«: báº£n vÆ°Æ¡ng, tháº§n, nÃ´ tÃ i, hoÃ ng thÆ°á»£ng, ngÆ°Æ¡i, ngÆ°á»i, tháº§n thiáº¿p...
Giá»¯ nguyÃªn phong vá»‹ cá»• phong trang nghiÃªm, cáº£m xÃºc rÃµ rÃ ng.`
  };

  const baseGuide = `
YÃªu cáº§u dá»‹ch:
- Dá»‹ch **chá»‰ pháº§n ná»™i dung thoáº¡i** tá»« tiáº¿ng Trung sang ${targetLang}.
- Tuyá»‡t Ä‘á»‘i **khÃ´ng viáº¿t láº¡i sá»‘ thá»© tá»± hoáº·c má»‘c thá»i gian** â€” chá»‰ tráº£ vá» pháº§n lá»i thoáº¡i dá»‹ch.
- KhÃ´ng thÃªm mÃ´ táº£ nhÆ° â€œDÆ°á»›i Ä‘Ã¢y lÃ  báº£n dá»‹châ€¦â€ hay â€œgiá»¯ nguyÃªn Ä‘á»‹nh dáº¡ng...â€.
- Má»—i Ä‘oáº¡n dá»‹ch tÆ°Æ¡ng á»©ng má»™t Ä‘oáº¡n thoáº¡i, giá»¯ nguyÃªn thá»© tá»±.
- Dá»‹ch sÃ¡t nghÄ©a tá»«ng cÃ¢u, tá»«ng chá»¯, thá»ƒ hiá»‡n Ä‘Ãºng cáº£m xÃºc vÃ  phong cÃ¡ch nhÃ¢n váº­t.
- KhÃ´ng lÆ°á»£c bá», khÃ´ng tÃ³m táº¯t, khÃ´ng thay Ä‘á»•i ngá»¯ khÃ­.
- CÃ¡c Ä‘oáº¡n thoáº¡i Ä‘Æ°á»£c ngÄƒn cÃ¡ch báº±ng <<<LINE>>>.
- Tráº£ vá» káº¿t quáº£ **chá»‰ gá»“m pháº§n vÄƒn báº£n dá»‹ch**, theo Ä‘Ãºng thá»© tá»±, khÃ´ng thÃªm dÃ²ng trá»‘ng hay tiÃªu Ä‘á».
`;

  return `${stylePrompts[style]}\n${baseGuide}\nDÆ°á»›i Ä‘Ã¢y lÃ  ná»™i dung cáº§n dá»‹ch:\n${lines.join('\n<<<LINE>>>\n')}`;
}

async function translateBatch(apiKey, batch, lang, style){
  const prompt = buildPrompt(style, lang, batch);
  const res = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",{
    method:"POST",
    headers:{"Content-Type":"application/json","X-Goog-Api-Key":apiKey},
    body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})
  });
  if(!res.ok)throw new Error(await res.text());
  const data=await res.json();
  const txt=data?.candidates?.[0]?.content?.parts?.[0]?.text||"";
  return txt.split("<<<LINE>>>").map(t=>t.trim());
}

async function copyToClipboardAndSelect(text){
  const resultBox = document.getElementById("result");
  resultBox.focus();

  // Táº¡o selection range Ä‘á»ƒ "select all"
  const range = document.createRange();
  range.selectNodeContents(resultBox);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);

  try {
    await navigator.clipboard.writeText(text);
    const status=document.getElementById("status");
    status.textContent+=" ğŸ“‹ (ÄÃ£ sao chÃ©p & chá»n toÃ n bá»™ báº£n dá»‹ch)";
  } catch(err) {
    console.warn("KhÃ´ng thá»ƒ sao chÃ©p clipboard:", err);
  }
}

document.getElementById("translateBtn").addEventListener("click",async()=>{
  const apiKey=document.getElementById("apiKey").value.trim();
  const style=document.getElementById("style").value;
  const lang=document.getElementById("lang").value;
  const file=document.getElementById("fileInput").files[0];
  const status=document.getElementById("status");
  const result=document.getElementById("result");
  if(!apiKey)return alert("Vui lÃ²ng nháº­p API Key");
  if(!file)return alert("ChÆ°a chá»n file .srt");
  status.textContent="ğŸ“– Äang Ä‘á»c file...";
  updateProgress(0);
  const text=await file.text();
  const subs=parseSRT(text);
  const total=subs.length,batchSize=50;
  let done=0;const translated=[];
  status.textContent=`ğŸš€ Báº¯t Ä‘áº§u dá»‹ch ${total} Ä‘oáº¡n theo phong cÃ¡ch '${style}'...`;
  try{
    for(let i=0;i<total;i+=batchSize){
      const batch=subs.slice(i,i+batchSize).map(s=>s.text);
      const lines=await translateBatch(apiKey,batch,lang,style);
      translated.push(...lines);
      done=Math.min(total,i+batchSize);
      const pct=Math.round((done/total)*100);
      updateProgress(pct);
      status.textContent=`âš™ï¸ Äang dá»‹ch... ${done}/${total} (${pct}%)`;
    }
    for(let i=0;i<subs.length;i++)subs[i].text=translated[i]||subs[i].text;
    const newSrt=formatSRT(subs);
    updateProgress(100);
    const blob=new Blob([newSrt],{type:"text/plain;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");a.href=url;a.download=`translated_${style}.srt`;a.click();
    URL.revokeObjectURL(url);
    result.textContent=newSrt.slice(0,1500)+(newSrt.length>1500?"\n...\n(Ä‘Ã£ rÃºt gá»n hiá»ƒn thá»‹)":"");
    status.textContent="ğŸ‰ HoÃ n táº¥t! File Ä‘Ã£ táº£i vá».";
    await copyToClipboardAndSelect(newSrt);
  }catch(e){
    status.textContent="âŒ Lá»—i: "+e.message;updateProgress(0);
  }
});
</script>
</body>
</html>